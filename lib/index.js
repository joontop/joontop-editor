!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.editor=t():e.editor=t()}(window,function(){return function(e){var t={};function n(a){if(t[a])return t[a].exports;var r=t[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(a,r,function(t){return e[t]}.bind(null,r));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/lib/",n(n.s=0)}([function(e,t,n){"use strict";function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}function r(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}n.r(t);var i=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options={hashClass:"hash",mentionClass:"mention",editorClass:"__editor",layerClass:"__layer",layerDataClass:"__layer_data",hashData:[],mentionData:[],target:null}}var t,n,i;return t=e,(n=[{key:"setDatas",value:function(e){a(this.options,e)}},{key:"getHashClass",value:function(){return this.options.hashClass}},{key:"getMentionClass",value:function(){return this.options.mentionClass}},{key:"getEditorClass",value:function(){return this.options.editorClass}},{key:"getLayerClass",value:function(){return this.options.layerClass}},{key:"getLayerDataClass",value:function(){return this.options.layerDataClass}},{key:"getHashData",value:function(){return this.options.hashData}},{key:"getMentionData",value:function(){return this.options.mentionData}},{key:"getTarget",value:function(){return this.options.target}}])&&r(t.prototype,n),i&&r(t,i),e}()),s={CSS:{width:"100%",height:"100%",overflow:"hidden",overflowY:"auto"}},o={CSS:{position:"absolute"}},l={HASHTAG:"#",MENTION:"@"},h="FONT",c={SPACEBAR:32,ENTER:13,BACKSPACE:8,DEL:46,PGUP:33,PGDN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,MENTION:50,HASHTAG:51,V:86},u={getTopToBody:function(e){var t=0;if(e.offsetParent)do{t+=e.offsetTop}while(e=e.offsetParent);return t},getLeftToBody:function(e){var t=0;if(e.offsetParent)do{t+=e.offsetLeft}while(e=e.offsetParent);return t},insertAfter:function(e,t){var n=t.parentNode;n.lastchild===t?n.appendChild(e):n.insertBefore(e,t.nextSibling)}};function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}function g(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i.setDatas(t),this.range=null,this.selection=null,this.editArea=null,this.layer=null,this.autoData=[],this.autoCnt=0,this.autoTarget=null,this.state={currentTag:null,isTag:!1},this.layerState={data:[],idx:0,isOpen:!1}}var t,n,a;return t=e,(n=[{key:"start",value:function(){this.editArea=this.getEditorElement(),this.layer=this.getLayerElement(),i.getTarget().appendChild(this.editArea),document.querySelector("body").appendChild(this.layer),this.setEvent()}},{key:"getEditorElement",value:function(){var e=document.createElement("div");return e.className=i.getEditorClass(),e.setAttribute("contentEditable",!0),e.setAttribute("spellcheck",!1),d(e.style,s.CSS),e}},{key:"getLayerElement",value:function(){var e=document.createElement("div");return e.className=i.getLayerClass(),d(e.style,o.CSS),e}},{key:"setEvent",value:function(){this.editArea&&(this.editArea.addEventListener("keydown",this.onKeydownEvent.bind(this)),this.editArea.addEventListener("keyup",this.onKeyupEvent.bind(this)),this.editArea.addEventListener("mouseup",this.onMouseupEvent.bind(this)),this.editArea.addEventListener("paste",this.onPasteEvent.bind(this)),document.addEventListener("keyup",this.onDocumentKeyUpEvent.bind(this)))}},{key:"onKeydownEvent",value:function(e){var t=e.which||e.keyCode;this.selection=window.getSelection(),this.selection.rangeCount<=0||(this.range=this.selection.getRangeAt(0),this.setTagState(),this.layerState.isOpen&&t===c.ENTER?e.preventDefault():this.layerState.isOpen&&t===c.UP?e.preventDefault():this.layerState.isOpen&&t===c.DOWN?e.preventDefault():(t===c.LEFT||t===c.UP||t===c.RIGHT||t===c.DOWN||(this.closeLayer(),this.autoComplete(e)),t===c.PGUP||t===c.PGDN||t===c.END||t===c.HOME||t===c.LEFT||t===c.UP||t===c.RIGHT||t===c.DOWN||t===c.SPACEBAR||t===c.ENTER||t===c.BACKSPACE||t===c.DEL||this.range.collapse(!0),e.ctrlKey&&t===c.V||(t===c.SPACEBAR?this.onPressSpacebarKey(e):t===c.ENTER?this.onPressEnterKey(e):e.shiftKey&&t===c.HASHTAG?this.onPressHashKey(e):e.shiftKey&&t===c.MENTION&&this.onPressMentionKey(e))))}},{key:"onKeyupEvent",value:function(e){var t=e.which||e.keyCode;this.selection=window.getSelection(),this.selection.rangeCount<=0||(this.range=this.selection.getRangeAt(0),this.setTagState(),this.layerState.isOpen&&t===c.ENTER?e.preventDefault():this.layerState.isOpen&&t===c.UP?e.preventDefault():this.layerState.isOpen&&t===c.DOWN?e.preventDefault():t===c.LEFT||t===c.UP||t===c.RIGHT||t===c.DOWN?(this.closeLayer(),this.autoComplete(e)):t!==c.BACKSPACE&&t!==c.DEL||this.checkTag())}},{key:"onMouseupEvent",value:function(){this.selection=window.getSelection(),this.selection.rangeCount<=0||(this.range=this.selection.getRangeAt(0),this.setTagState(),this.range.commonAncestorContainer.parentNode.nodeName.toUpperCase()===h||this.closeLayer())}},{key:"onPasteEvent",value:function(e){e.preventDefault();var t=(e.clipboardData||window.clipboardData).getData("text/plain");t=(t=(t=t.replace(/([#])\w+/gi,"<"+h+" class='"+i.getHashClass()+"'>$&</"+h+">")).replace(/([@])\w+/gi,"<"+h+" class='"+i.getMentionClass()+"'>$&</"+h+">")).replace(/\n/gi,"<br>");var n=document.createTextNode(t);this.range.insertNode(n),this.range.setStartAfter(n),this.range.collapse(!0),this.selection.removeAllRanges(),this.selection.addRange(this.range),this.editArea.innerHTML=this.editArea.innerHTML.replace(/&lt;/gi,"<").replace(/&gt;/gi,">")}},{key:"onPressHashKey",value:function(e){e.preventDefault(),this.state.currentTag=l.HASHTAG,this.insertTag(l.HASHTAG,i.getHashClass())}},{key:"onPressMentionKey",value:function(e){e.preventDefault(),this.state.currentTag=l.MENTION,this.insertTag(l.MENTION,i.getMentionClass())}},{key:"onPressSpacebarKey",value:function(e){e.preventDefault(),this.insertSpacebar()}},{key:"onPressEnterKey",value:function(e){e.preventDefault(),this.insertEnter()}},{key:"setTagState",value:function(){if(this.range.commonAncestorContainer){var e=this.range.commonAncestorContainer;this.state.isTag=e.nodeName.toUpperCase()===h||e.parentNode.nodeName.toUpperCase()===h}}},{key:"checkTag",value:function(){var e=null,t=[];this.range.commonAncestorContainer.parentNode&&"DIV"===this.range.commonAncestorContainer.parentNode.nodeName?(e=this.range.commonAncestorContainer.parentNode,t=this.range.commonAncestorContainer.parentNode.childNodes):this.range.commonAncestorContainer.parentNode.parentNode&&"DIV"===this.range.commonAncestorContainer.parentNode.parentNode.nodeName&&(e=this.range.commonAncestorContainer.parentNode.parentNode,t=this.range.commonAncestorContainer.parentNode.parentNode.childNodes);for(var n=0;n<t.length;n++)t[n].nodeName===h&&(0===t[n].innerHTML.indexOf(l.HASHTAG)||0===t[n].innerHTML.indexOf(l.MENTION)||(u.insertAfter(document.createTextNode(t[n].innerHTML),t[n]),e.removeChild(t[n])))}},{key:"insertTag",value:function(e,t){if(!this.state.isTag){var n=document.createElement(h),a=document.createTextNode(e);n.setAttribute("class",t),n.appendChild(a),this.range.insertNode(n),this.range.setStartAfter(a),this.range.collapse(!0),this.selection.removeAllRanges(),this.selection.addRange(this.range),this.setPositionLayer(n),this.state.isTag=!0}}},{key:"insertSpacebar",value:function(){var e=document.createTextNode(" ");document.createTextNode(" ");this.processRemainingText(e),this.selection.removeAllRanges(),this.selection.addRange(this.range)}},{key:"insertEnter",value:function(){var e=document.createElement("br"),t=document.createTextNode(" ");this.processRemainingText(e),this.range.insertNode(t),this.range.setStartBefore(t),this.selection.removeAllRanges(),this.selection.addRange(this.range),document.execCommand("delete")}},{key:"processRemainingText",value:function(e){if(this.state.isTag){var t=this.range.commonAncestorContainer,n=document.createTextNode(t.data.substring(0,this.range.startOffset)),a=document.createTextNode(t.data.substring(this.range.startOffset,t.data.length));this.range.selectNode(t),this.selection.getRangeAt(this.range.startOffset),this.range.deleteContents(),this.range.insertNode(n),this.range.commonAncestorContainer.nodeName===h?(u.insertAfter(a,this.range.commonAncestorContainer),u.insertAfter(e,this.range.commonAncestorContainer)):(u.insertAfter(a,this.range.commonAncestorContainer.parentNode),u.insertAfter(e,this.range.commonAncestorContainer.parentNode)),this.range.setStartBefore(a)}else this.range.insertNode(e),this.range.setStartAfter(e)}},{key:"autoComplete",value:function(e){var t=e.which||e.keyCode;if(this.selection=window.getSelection(),!(this.selection.rangeCount<=0)&&(this.range=this.selection.getRangeAt(0),this.setTagState(),this.state.isTag)){var n=String.fromCharCode(e.keyCode)||null;if(t===c.BACKSPACE||t===c.LEFT||t===c.UP||t===c.RIGHT||t===c.DOWN){if(this.range.commonAncestorContainer.parentNode.nodeName.toUpperCase()===h){n=this.range.commonAncestorContainer.parentNode.innerHTML.substring(0,this.range.commonAncestorContainer.parentNode.innerHTML.length-1);var a=this.range.commonAncestorContainer.parentNode;this.setPositionLayer(a)}}else if(this.range.commonAncestorContainer.parentNode.nodeName.toUpperCase()===h){n=this.range.commonAncestorContainer.parentNode.innerHTML+String.fromCharCode(e.keyCode);var r=this.range.commonAncestorContainer.parentNode;this.setPositionLayer(r)}n=(n=(n=n.replace(l.HASHTAG,"")).replace(l.MENTION,"")).toLowerCase(),this.setLayer(n)}}},{key:"setLayer",value:function(e){if(this.state.currentTag===l.HASHTAG?this.layerState.data=i.getHashData():this.state.currentTag===l.MENTION&&(this.layerState.data=i.getMentionData()),e.length>0){this.autoData=[],this.autoCnt=0;for(var t=0,n=this.layerState.data.length;t<n;t++){-1!==this.layerState.data[t].substring(0,e.length).indexOf(e)&&(this.autoData.push(t),this.autoCnt++)}this.renderLayer()}}},{key:"setPositionLayer",value:function(e){var t=u.getTopToBody(e),n=u.getLeftToBody(e),a=e.offsetHeight,r=this.editArea.scrollTop;this.autoTarget=e,this.layer&&d(this.layer.style,{top:t+a-r+"px",left:n+"px"})}},{key:"renderLayer",value:function(){var e=0;this.layer.innerHTML="";for(var t=0,n=this.autoCnt;t<n;t++){e=this.autoData[t];var a=document.createElement("div");a.className=i.getLayerDataClass(),a.setAttribute("data-idx",e),a.innerHTML=this.layerState.data[e],a.addEventListener("click",this.onAutoData.bind(this)),this.layer.appendChild(a)}0!==this.autoCnt&&this.openLayer()}},{key:"onAutoData",value:function(e){e.preventDefault(),this.autoTarget.innerHTML=this.state.currentTag+e.target.innerHTML,this.editArea.focus(),window.getSelection().selectAllChildren(this.autoTarget),this.selection.removeAllRanges(),this.range.setStartAfter(this.autoTarget),this.selection.addRange(this.range);var t=document.createTextNode(" ");this.range.insertNode(t),this.selection.removeAllRanges(),this.range.setStartAfter(t),this.selection.addRange(this.range),this.closeLayer()}},{key:"onDocumentKeyUpEvent",value:function(e){var t=e.which||e.keyCode;if(this.layerState.isOpen)if(t===c.DOWN)this.layerState.idx<this.autoCnt-1&&(this.layerState.idx++,this.resetLayer(),this.layer.querySelectorAll("."+i.getLayerDataClass())[this.layerState.idx].classList.add("on"));else if(t===c.UP)this.layerState.idx>0&&(this.layerState.idx--,this.resetLayer(),this.layer.querySelectorAll("."+i.getLayerDataClass())[this.layerState.idx].classList.add("on"));else if(t===c.ENTER){this.autoTarget.innerHTML=this.state.currentTag+this.layer.querySelectorAll("."+i.getLayerDataClass())[this.layerState.idx].innerHTML,window.getSelection().selectAllChildren(this.autoTarget),this.selection.removeAllRanges(),this.range.setStartAfter(this.autoTarget),this.selection.addRange(this.range);var n=document.createTextNode(" ");this.range.insertNode(n),this.selection.removeAllRanges(),this.range.setStartAfter(n),this.selection.addRange(this.range),this.closeLayer()}}},{key:"resetLayer",value:function(){if(this.layer)for(var e=this.layer.querySelectorAll("."+i.getLayerDataClass()),t=0,n=e.length;t<n;t++)e[t].classList.remove("on")}},{key:"openLayer",value:function(){this.layer&&(this.layer.style.display="block",this.layer.querySelectorAll("."+i.getLayerDataClass())[this.layerState.idx].classList.add("on"),this.layerState.isOpen=!0)}},{key:"closeLayer",value:function(){this.layer&&(this.layer.innerHTML="",this.layer.style.display="none",this.layerState.isOpen=!1,this.layerState.idx=0)}}])&&g(t.prototype,n),a&&g(t,a),e}();t.default=y}])});